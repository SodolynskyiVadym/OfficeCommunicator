@inject ContactApiService ContactApiService
@inject ChatApiService ChatApiService


<div class="chat-container">
	<div style="display: flex; justify-content: space-between; align-items: center;">
		<h1 style="margin: 0;">@Group.Name</h1>
		<div>
			<img src="images/add-user.png" @onclick="() => AddPerson()" style="max-width: 40px; max-height: 40px; cursor: pointer; margin-left: 10px;" />
			<img src="images/phone-call.png" @onclick="() => CallGroup()" style="max-width: 40px; max-height: 40px; cursor: pointer; margin-left: 10px;" />
			<img src="images/exit.png" @onclick="() => CallGroup()" style="max-width: 40px; max-height: 40px; cursor: pointer; margin-left: 10px;" />
		</div>
	</div>

	<div class="messages-container">
		@foreach (var message in Group.Chat.Messages)
		{
			<div class="message-wrapper @(message.UserId == UserId ? "my-message" : "other-message")">
				<div style="display: flex">
					@if (message.UserId == UserId)
					{
						<img src="images/delete.png" class="image-action" @onclick="() => DeleteMessage(message.Id)" />
						<img src="images/pencil.png" class="image-action" @onclick="() => ActivateUpdateMessage(message.Id)" />
					}
					<div class="message-content">
						<p>@message.Content</p>
						@foreach (var file in message.Documents)
						{
							<div style="display: flex; align-items: center;">
								<p class="file-link" @onclick="() => DownloadFile(file.Id, file.MessageId, file.Name)" style="padding-right: 10px;">
									@file.Name
								</p>
								@if (message.UserId == UserId)
								{
									<img src="images/delete.png" class="image-action" @onclick="() => DeleteDocument(file.Id, message.Id)" />

								}
							</div>
						}
					</div>
				</div>

			</div>
		}
	</div>

	<div class="input-container">
		<textarea type="text" @bind="content" class="message-input" placeholder="Type your message..." />
		@if (isUpdating)
		{
			<button class="send-button" @onclick="() => UpdateMessage()">Update</button>
			<button class="send-button" @onclick="() => CancelUpdating()">Cancel</button>

		}
		else
		{
			<button class="send-button" @onclick="SendMessage">Send</button>
			<div class="file-inputs">
				@for (int i = 0; i < countInputsFiles; i++)
				{
					<InputFile @key="i" OnChange="HandleFileSelection" style="@GetInputFileStyle(i)" multiple></InputFile>
				}
			</div>
		}

	</div>
</div>

@code {

	[Parameter]
	public Group Group { get; set; }

	[Parameter]
	public int UserId { get; set; }

	[Parameter]
	public EventCallback<MessageStorageDto> OnSendMessage { get; set; }

	[Parameter]
	public EventCallback<DownloadFileRequestDto> OnDownloadFile { get; set; }

	[Parameter]
	public EventCallback<int> OnCallGroup { get; set; }

	[Parameter]
	public EventCallback<MessageStorageDto> OnUpdateMessage { get; set; }

	[Parameter]
	public EventCallback<DocumentMessageChatId> OnDeleteMessage { get; set; }

	[Parameter]
	public EventCallback<DocumentMessageChatId> OnDeleteDocument { get; set; }

	private string content { get; set; } = string.Empty;
	private int countInputsFiles { get; set; } = 1;
	private bool isUpdating { get; set; } = false;
	private int updatingMessageId { get; set; } = 0;

	private List<IBrowserFile> SelectedFiles { get; set; } = new();


	protected override async Task OnInitializedAsync()
	{
		Group.Chat.Messages = Group.Chat.Messages.OrderBy(m => m.Date).ToList();
	}


	private async Task SendMessage()
	{
		List<Document> documents = new();
		foreach (var file in SelectedFiles)
		{
			documents.Add(new Document()
				{
					Name = file.Name,
					UniqueIdentifier = string.Empty

				});
		}
		Group.Chat.Messages.Add(new Message()
			{
				Content = content,
				UserId = UserId,
				ChatId = Group.ChatId,
				Date = DateTime.Now,
				Documents = documents
			});
		await OnSendMessage.InvokeAsync(new MessageStorageDto(UserId, nameof(Group), Group.ChatId, content, SelectedFiles));

		content = string.Empty;
	}


	private async Task DownloadFile(int fileId, int messageId, string fileName)
	{
		if (fileId > 0) await OnDownloadFile.InvokeAsync(new DownloadFileRequestDto(fileId, messageId, fileName));
	}


	private string GetInputFileStyle(int index)
	{
		return index == countInputsFiles - 1 ? "" : "display: none";
	}


	private void HandleFileSelection(InputFileChangeEventArgs e)
	{
		countInputsFiles++;
		var files = e.GetMultipleFiles().ToList();
		foreach (var file in files)
		{
			if (SelectedFiles.Any(f => f.Name == file.Name)) SelectedFiles.RemoveAll(f => f.Name == file.Name);
			SelectedFiles.Add(file);
		}
	}


	private async Task CallGroup()
	{
		await OnCallGroup.InvokeAsync(Group.ChatId);
	}


	private async Task UpdateMessage()
	{
		Message? message = Group.Chat.Messages.FirstOrDefault(m => m.Id == updatingMessageId);
		if (message != null)
		{
			await OnUpdateMessage.InvokeAsync(new MessageStorageDto() { Content = content, ChatId = Group.ChatId, Id = updatingMessageId, UserId = UserId });

			Group.Chat.Messages.Remove(message);
			message.Content = content;
			Group.Chat.Messages.Add(message);
			Group.Chat.Messages = Group.Chat.Messages.OrderBy(m => m.Date).ToList();
		}

		content = string.Empty;
		updatingMessageId = 0;
		isUpdating = false;

		await InvokeAsync(StateHasChanged);
	}

	private async Task DeleteMessage(int messageId)
	{
		Message? message = Group.Chat.Messages.FirstOrDefault(m => m.Id == messageId);
		if (message == null) return;
		Group.Chat.Messages.Remove(message);
		await OnDeleteMessage.InvokeAsync(new DocumentMessageChatId(0, messageId, Group.ChatId));

	}

	private async Task DeleteDocument(int documentId, int messageId)
	{
		await OnDeleteDocument.InvokeAsync(new DocumentMessageChatId(documentId, messageId, Group.ChatId));

		var message = Group.Chat.Messages.FirstOrDefault(m => m.Documents.Any(d => d.Id == documentId));
		if (message == null) return;
		var document = message.Documents.FirstOrDefault(d => d.Id == documentId);
		if (document == null) return;
		message.Documents.Remove(document);

		await InvokeAsync(StateHasChanged);
	}


	private async Task ActivateUpdateMessage(int messageId)
	{
		Message? message = Group.Chat.Messages.FirstOrDefault(m => m.Id == messageId);
		if (message == null) return;
		content = message.Content;
		updatingMessageId = messageId;
		isUpdating = true;
		await InvokeAsync(StateHasChanged);
	}

	private async Task CancelUpdating()
	{
		content = string.Empty;
		updatingMessageId = 0;
		isUpdating = false;
		await InvokeAsync(StateHasChanged);
	}



	private async Task AddPerson()
	{
		
	}
}
